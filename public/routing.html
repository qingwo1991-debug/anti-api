<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anti-API Routing</title>
    <link rel="icon"
        href="https://t0.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=http://antigravity.google&size=32"
        type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Theme Variables (Default: Midnight) */
        :root {
            --theme-bg: #000000;
            --theme-card-bg: transparent;
            --theme-card-border: rgba(55, 65, 81, 0.5);
            --theme-text: #d1d5db;
            --theme-text-muted: #6b7280;
            --theme-accent: #22d3ee;
        }

        /* Theme: Midnight (Default) */
        [data-theme="midnight"] {
            --theme-bg: #000000;
            --theme-card-bg: transparent;
            --theme-card-border: rgba(55, 65, 81, 0.5);
            --theme-text: #d1d5db;
            --theme-text-muted: #6b7280;
            --theme-accent: #22d3ee;
        }

        /* Theme: Cyberpunk */
        [data-theme="cyberpunk"] {
            --theme-bg: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            --theme-card-bg: rgba(48, 43, 99, 0.4);
            --theme-card-border: rgba(255, 0, 128, 0.3);
            --theme-text: #ff00ff;
            --theme-text-muted: #a855f7;
            --theme-accent: #ff0080;
        }

        /* Theme: Ocean */
        [data-theme="ocean"] {
            --theme-bg: linear-gradient(180deg, #0a1628 0%, #0d2137 50%, #0f172a 100%);
            --theme-card-bg: rgba(14, 165, 233, 0.08);
            --theme-card-border: rgba(14, 165, 233, 0.25);
            --theme-text: #7dd3fc;
            --theme-text-muted: #0ea5e9;
            --theme-accent: #38bdf8;
        }

        /* Theme: Forest */
        [data-theme="forest"] {
            --theme-bg: linear-gradient(180deg, #052e16 0%, #14532d 50%, #0c1f0f 100%);
            --theme-card-bg: rgba(34, 197, 94, 0.1);
            --theme-card-border: rgba(34, 197, 94, 0.3);
            --theme-text: #86efac;
            --theme-text-muted: #22c55e;
            --theme-accent: #4ade80;
        }

        /* Theme: Sunset */
        [data-theme="sunset"] {
            --theme-bg: linear-gradient(135deg, #1a0a0a 0%, #2d1810 50%, #1f0f05 100%);
            --theme-card-bg: rgba(251, 146, 60, 0.1);
            --theme-card-border: rgba(251, 146, 60, 0.3);
            --theme-text: #fed7aa;
            --theme-text-muted: #fb923c;
            --theme-accent: #f97316;
        }

        /* Theme: Aurora */
        [data-theme="aurora"] {
            --theme-bg: linear-gradient(135deg, #0f172a 0%, #1e1b4b 30%, #134e4a 70%, #1e3a5f 100%);
            --theme-card-bg: rgba(139, 92, 246, 0.1);
            --theme-card-border: rgba(139, 92, 246, 0.3);
            --theme-text: #c4b5fd;
            --theme-text-muted: #a78bfa;
            --theme-accent: #8b5cf6;
        }

        /* Theme: Warm */
        [data-theme="warm"] {
            --theme-bg: #1c1917;
            --theme-card-bg: rgba(120, 113, 108, 0.15);
            --theme-card-border: rgba(168, 162, 158, 0.3);
            --theme-text: #e7e5e4;
            --theme-text-muted: #a8a29e;
            --theme-accent: #fbbf24;
        }

        :root {
            --bg-black: var(--theme-bg);
            --panel: var(--theme-card-bg);
            --panel-border: var(--theme-card-border);
            --node-border: rgba(255, 255, 255, 0.06);
            --node-accent: var(--theme-accent);
            --node-glow: rgba(110, 231, 255, 0.35);
            --grid: rgba(255, 255, 255, 0.04);
            --grid-strong: rgba(255, 255, 255, 0.08);
        }

        body {
            background: var(--theme-bg);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: var(--theme-text);
        }

        .grid-bg {
            background-image:
                linear-gradient(var(--grid) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid) 1px, transparent 1px);
            background-size: 32px 32px;
        }

        .grid-bg::after {
            content: "";
            position: absolute;
            inset: 0;
            background-image:
                linear-gradient(var(--grid-strong) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-strong) 1px, transparent 1px);
            background-size: 160px 160px;
            pointer-events: none;
            opacity: 0.6;
        }

        .panel {
            background: var(--panel);
            border: 1px solid var(--panel-border);
            backdrop-filter: blur(12px);
        }

        #flow-panel .panel,
        #account-panel .panel {
            background: var(--bg-black);
        }

        #flow-panel .grid-bg,
        #account-panel .grid-bg {
            background-image: none;
        }

        #flow-panel .grid-bg::after,
        #account-panel .grid-bg::after {
            display: none;
        }

        .node {
            border: 1px solid var(--node-border);
            background: var(--theme-card-bg, rgba(20, 20, 20, 0.9));
            box-shadow: 0 0 0 rgba(0, 0, 0, 0);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            color: var(--theme-text);
        }

        .node:hover {
            transform: translateY(-2px);
            border-color: var(--node-accent);
            box-shadow: 0 0 20px var(--node-glow);
        }

        .node-palette {
            background: linear-gradient(145deg, color-mix(in srgb, var(--theme-accent) 12%, transparent), var(--theme-card-bg, rgba(10, 10, 10, 0.9)));
            border-color: color-mix(in srgb, var(--theme-accent) 20%, transparent);
            box-shadow: 0 0 12px color-mix(in srgb, var(--theme-accent) 8%, transparent);
            position: relative;
            overflow: hidden;
        }

        .node-palette::before {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(120deg, color-mix(in srgb, var(--theme-accent) 12%, transparent), transparent 50%);
            opacity: 0.3;
            pointer-events: none;
        }

        .node-palette::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, color-mix(in srgb, var(--theme-accent) 60%, transparent), transparent);
            opacity: 0.5;
        }

        .panel-scroll {
            scrollbar-width: thin;
            scrollbar-color: color-mix(in srgb, var(--theme-accent) 30%, transparent) transparent;
            padding-right: 6px;
        }

        .panel-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .panel-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .panel-scroll::-webkit-scrollbar-thumb {
            background: color-mix(in srgb, var(--theme-accent) 30%, transparent);
            border-radius: 3px;
        }

        .panel-scroll::-webkit-scrollbar-thumb:hover {
            background: color-mix(in srgb, var(--theme-accent) 50%, transparent);
        }

        .drop-slot {
            width: 100%;
            min-height: 84px;
            border: 1px dashed var(--theme-text-muted);
            border-radius: 12px;
            padding: 16px 16px;
            text-align: center;
            color: var(--theme-text-muted);
            transition: border-color 0.2s ease, color 0.2s ease;
            background: linear-gradient(135deg, color-mix(in srgb, var(--theme-accent) 5%, transparent), color-mix(in srgb, var(--theme-text) 2%, transparent));
            position: relative;
        }

        .drop-slot.active {
            border-color: var(--theme-accent);
            color: var(--theme-accent);
        }

        .drop-slot::after {
            content: "+";
            position: absolute;
            top: 8px;
            right: 10px;
            font-size: 14px;
            color: var(--theme-text-muted);
        }

        .account-pill {
            background: color-mix(in srgb, var(--theme-text) 4%, transparent);
            border: 1px solid color-mix(in srgb, var(--theme-text) 8%, transparent);
            color: var(--theme-text-muted);
        }

        .node {
            padding-top: 14px !important;
            padding-bottom: 14px !important;
        }

        .action-btn {
            padding-top: 10px !important;
            padding-bottom: 10px !important;
        }

        .account-pill {
            padding-top: 4px !important;
            padding-bottom: 4px !important;
        }

        .action-wrap {
            perspective: 1000px;
        }

        .action-btn {
            transform-style: preserve-3d;
            transition: box-shadow 0.3s ease, background 0.3s ease, border-color 0.3s ease;
            background: var(--theme-card-bg, rgba(17, 17, 17, 0.9));
            backdrop-filter: blur(10px);
            border: 1px solid var(--theme-card-border);
            color: var(--theme-text);
        }

        #back-btn:hover {
            background: rgba(71, 150, 227, 0.15);
            border-color: #4796E3;
            box-shadow: 0 0 20px rgba(71, 150, 227, 0.4),
                0 0 40px rgba(71, 150, 227, 0.2);
        }

        #save-btn:hover {
            background: rgba(34, 197, 94, 0.18);
            border-color: rgba(34, 197, 94, 0.7);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.45),
                0 0 42px rgba(34, 197, 94, 0.25);
        }

        #new-btn:hover {
            background: rgba(110, 231, 255, 0.18);
            border-color: rgba(110, 231, 255, 0.7);
            box-shadow: 0 0 20px rgba(110, 231, 255, 0.45),
                0 0 42px rgba(110, 231, 255, 0.25);
        }

        .flow-canvas {
            position: relative;
            padding: 12px 6px 28px;
        }

        .flow-lines {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 1;
        }

        .flow-node {
            position: relative;
            border-color: color-mix(in srgb, var(--theme-accent) 30%, transparent);
            background: linear-gradient(145deg, color-mix(in srgb, var(--theme-accent) 14%, transparent), var(--theme-card-bg, rgba(10, 10, 10, 0.9)));
            box-shadow: 0 0 24px color-mix(in srgb, var(--theme-accent) 12%, transparent);
            overflow: hidden;
            z-index: 2;
        }

        .flow-node::before {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(120deg, color-mix(in srgb, var(--theme-accent) 18%, transparent), transparent 50%);
            opacity: 0.4;
            pointer-events: none;
        }

        .flow-node::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, color-mix(in srgb, var(--theme-accent) 80%, transparent), transparent);
            opacity: 0.6;
        }

        .flow-node.drop-target {
            border-color: color-mix(in srgb, var(--theme-accent) 85%, transparent);
            box-shadow: 0 0 26px color-mix(in srgb, var(--theme-accent) 35%, transparent);
        }

        .flow-badge {
            width: 22px;
            height: 22px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: color-mix(in srgb, var(--theme-accent) 20%, transparent);
            color: var(--theme-accent);
            font-size: 11px;
            font-weight: 700;
        }

        .flow-port {
            position: absolute;
            left: 50%;
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: var(--theme-card-bg, rgba(10, 10, 10, 0.9));
            border: 1px solid color-mix(in srgb, var(--theme-accent) 60%, transparent);
            box-shadow: 0 0 10px color-mix(in srgb, var(--theme-accent) 40%, transparent);
            transform: translateX(-50%);
            pointer-events: none;
        }

        .flow-port-top {
            top: -6px;
        }

        .flow-port-bottom {
            bottom: -6px;
        }

        .flow-line-core {
            stroke: url(#flow-gradient);
            stroke-width: 2.2;
            fill: none;
            opacity: 0.9;
            stroke-dasharray: 12 8;
            animation: flow-dash 8s linear infinite;
        }

        .flow-line-glow {
            stroke: url(#flow-gradient);
            stroke-width: 6;
            fill: none;
            opacity: 0.25;
            filter: url(#flow-glow);
        }

        @keyframes flow-dash {
            to {
                stroke-dashoffset: -200;
            }
        }
    </style>
    <style id="iframe-styles">
        /* Iframe embed mode styles - match parent page background */
        body.iframe-mode {
            padding: 0 !important;
            background: var(--bg-black) !important;
            overflow: hidden !important;
        }

        body.iframe-mode .main-container {
            max-width: 100% !important;
            margin: 0 !important;
            padding: 8px !important;
            margin-top: 0 !important;
            gap: 0 !important;
        }

        body.iframe-mode .main-container>.space-y-6 {
            margin-top: 0 !important;
        }

        body.iframe-mode header #back-btn {
            display: none !important;
        }

        body.iframe-mode header .action-wrap {
            display: none !important;
        }

        .toggle-switch {
            appearance: none;
            width: 48px;
            height: 28px;
            background: #333;
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: #666;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .toggle-switch:checked {
            background: linear-gradient(135deg, #22d3ee, #3b82f6);
        }

        .toggle-switch:checked::before {
            left: 22px;
            background: white;
        }

        .routing-panels {
            height: calc(100vh - 160px);
            min-height: 520px;
        }

        .select-field {
            appearance: none;
            background-color: var(--theme-card-bg, rgba(10, 10, 10, 0.8));
            border: 1px solid color-mix(in srgb, var(--theme-accent) 22%, transparent);
            color: var(--theme-text);
            border-radius: 12px;
            padding: 12px 36px 12px 12px;
            font-size: 12px;
            line-height: 1.2;
            box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--theme-accent) 8%, transparent);
            background-image:
                linear-gradient(45deg, transparent 50%, var(--theme-accent) 50%),
                linear-gradient(135deg, var(--theme-accent) 50%, transparent 50%),
                linear-gradient(90deg, var(--theme-card-bg, rgba(10, 10, 10, 0.9)), var(--theme-card-bg, rgba(10, 10, 10, 0.9)));
            background-position:
                calc(100% - 18px) 50%,
                calc(100% - 12px) 50%,
                100% 0;
            background-size: 6px 6px, 6px 6px, 40px 100%;
            background-repeat: no-repeat;
        }

        .select-field:focus {
            outline: none;
            border-color: color-mix(in srgb, var(--theme-accent) 60%, transparent);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--theme-accent) 18%, transparent);
        }
    </style>
</head>

<body class="min-h-screen p-6">
    <script>
        // Immediately detect iframe before DOM renders
        if (window.self !== window.top) {
            document.body.classList.add('iframe-mode');
        }
    </script>
    <div class="max-w-7xl mx-auto space-y-6 main-container">
        <header class="flex items-center justify-between">
            <div>
                <h1 id="routing-title" class="text-3xl font-bold" style="color: var(--theme-text);">Routing</h1>
                <p id="routing-subtitle" class="text-sm mt-1 font-bold" style="color: var(--theme-text-muted);">Build model chains with fallback on 429</p>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 text-xs">
                    <button id="tab-flow" onclick="setRoutingTab('flow')"
                        class="action-btn px-3 py-2 rounded-lg font-bold text-gray-300">
                        <span data-rt="flowRouting">Flow Routing</span>
                    </button>
                    <button id="tab-account" onclick="setRoutingTab('account')"
                        class="action-btn px-3 py-2 rounded-lg font-bold text-gray-400">
                        <span data-rt="accountRouting">Account Routing</span>
                    </button>
                    <button id="tab-mapping" onclick="setRoutingTab('mapping')"
                        class="action-btn px-3 py-2 rounded-lg font-bold text-gray-400">
                        <span data-rt="modelMapping">Model Mapping</span>
                    </button>
                </div>
                <div class="action-wrap inline-block">
                    <button onclick="window.location.href='/quota'" id="back-btn"
                        class="action-btn px-4 py-2 rounded-lg font-bold text-gray-300 text-sm">
                        <span data-rt="backToQuota">Back to Quota</span>
                    </button>
                </div>
            </div>
        </header>

        <div id="flow-panel" class="grid gap-6 routing-panels" style="grid-template-columns: 1fr 1.5fr 1fr;">
            <aside class="panel rounded-2xl p-4 flex flex-col min-h-0">
                <div class="mb-3 flex-shrink-0">
                    <h2 class="text-sm uppercase tracking-[0.2em]" style="color: var(--theme-text-muted);" data-rt="accounts">Accounts</h2>
                    <p class="text-xs mt-1" style="color: var(--theme-text-muted);" data-rt="accountsHint">Drag a model block into the flow.</p>
                </div>
                <div id="account-list" class="space-y-4 flex-1 min-h-0 overflow-y-auto panel-scroll"></div>
            </aside>

            <!-- Flow Panel -->
            <section class="relative panel rounded-2xl p-6 grid-bg overflow-hidden flex flex-col">
                <div class="relative z-10 flex flex-col flex-1 min-h-0 overflow-hidden">
                    <!-- Flow Header -->
                    <div class="flex items-start justify-between gap-3 mb-4 flex-shrink-0">
                        <div>
                            <h2 class="text-sm uppercase tracking-[0.2em]" style="color: var(--theme-text-muted);" data-rt="flow">Flow</h2>
                            <p class="text-xs mt-1" style="color: var(--theme-text-muted);" data-rt="flowHint">Match by model name in requests.</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <input id="flow-name" placeholder="Model ID"
                                class="bg-transparent border rounded-lg px-2 py-2 text-xs focus:outline-none w-24 text-center"
                                style="border-color: var(--theme-card-border); color: var(--theme-text);"
                                autocomplete="off" />
                            <div class="action-wrap inline-block">
                                <button onclick="newFlow()" id="new-btn"
                                    class="action-btn px-3 py-2 rounded-lg font-bold text-gray-300 text-xs" data-rt="new">
                                    New
                                </button>
                            </div>
                            <div class="action-wrap inline-block">
                                <button onclick="saveRouting()" id="save-btn"
                                    class="action-btn px-3 py-2 rounded-lg font-bold text-gray-300 text-xs" data-rt="save">
                                    Save
                                </button>
                            </div>
                        </div>
                    </div>
                <div id="save-status" class="text-xs text-right mb-2 flex-shrink-0" style="color: var(--theme-text-muted);"></div>
                    <!-- Scrollable Flow Canvas -->
                    <div class="flow-scroll flex-1 min-h-0 overflow-y-auto panel-scroll">
                        <div id="flow-canvas" class="flow-canvas flex flex-col gap-4 min-h-[240px]"></div>
                    </div>
                </div>
            </section>

            <!-- Saved Panel -->
            <aside class="panel rounded-2xl p-4 flex flex-col min-h-0">
                <div class="mb-3 flex-shrink-0">
                    <h2 class="text-sm uppercase tracking-[0.2em]" style="color: var(--theme-text-muted);" data-rt="saved">Saved</h2>
                    <p class="text-xs mt-1" style="color: var(--theme-text-muted);" data-rt="savedHint">Edit, rename, or delete saved flows.</p>
                </div>
                <div id="saved-list" class="space-y-3 flex-1 min-h-0 overflow-y-auto panel-scroll"></div>
            </aside>
        </div>

        <div id="account-panel" class="grid gap-6 hidden routing-panels" style="grid-template-columns: 1fr 2fr;">
            <aside class="panel rounded-2xl p-4 flex flex-col min-h-0">
                <div class="mb-3 flex-shrink-0">
                    <h2 class="text-sm uppercase tracking-[0.2em]" style="color: var(--theme-text-muted);" data-rt="models">Models</h2>
                    <p class="text-xs mt-1" style="color: var(--theme-text-muted);" data-rt="modelsHint">Official model IDs only.</p>
                </div>
                <div id="account-model-list" class="space-y-2 flex-1 min-h-0 overflow-y-auto panel-scroll"></div>
            </aside>

            <section class="panel rounded-2xl p-6 flex flex-col min-h-0">
                <div class="flex items-start justify-between gap-3 mb-4 flex-shrink-0">
                    <div>
                        <h2 class="text-sm uppercase tracking-[0.2em]" style="color: var(--theme-text-muted);" data-rt="accountChain">Account Chain</h2>
                        <p class="text-xs mt-1" style="color: var(--theme-text-muted);" data-rt="accountChainHint">Ordered provider/account fallback.</p>
                    </div>
                    <div class="flex items-center gap-2 text-xs" style="color: var(--theme-text-muted);">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input id="smart-switch" type="checkbox" class="toggle-switch">
                            <span data-rt="smartSwitch">Smart Switch</span>
                        </label>
                        <button id="account-save-btn" onclick="saveAccountRouting()"
                            class="action-btn px-3 py-2 rounded-lg font-bold text-xs" data-rt="save">
                            Save
                        </button>
                    </div>
                </div>

                <div id="account-route-title" class="text-sm mb-3 flex-shrink-0" style="color: var(--theme-text-muted);" data-rt="selectModel">Select a model</div>

                <div class="grid gap-3 mb-4 flex-shrink-0" style="grid-template-columns: 1fr 1fr auto;">
                    <select id="account-provider-select" class="select-field w-full">
                        <option value="" data-rt="provider">Provider</option>
                    </select>
                    <select id="account-account-select" class="select-field w-full">
                        <option value="" data-rt="account">Account</option>
                    </select>
                    <button onclick="addAccountRouteEntry()"
                        class="action-btn px-3 py-2 rounded-lg font-bold text-gray-300 text-xs" data-rt="add">
                        Add
                    </button>
                </div>

                <div id="account-route-list" class="space-y-3 flex-1 min-h-0 overflow-y-auto panel-scroll"></div>
                <div id="account-route-hint" class="text-xs mt-3 flex-shrink-0" style="color: var(--theme-text-muted);" data-rt="smartSwitchOn">
                    Smart Switch on: auto entries expand by account order.
                </div>
            </section>
        </div>

        <!-- Model Mapping Panel -->
        <div id="mapping-panel" class="hidden routing-panels">
            <section class="panel rounded-2xl p-6 flex flex-col min-h-0 max-w-4xl mx-auto">
                <div class="flex items-start justify-between gap-3 mb-4 flex-shrink-0">
                    <div>
                        <h2 class="text-sm uppercase tracking-[0.2em]" style="color: var(--theme-text-muted);" data-rt="modelMapping">Model Mapping</h2>
                        <p class="text-xs mt-1" style="color: var(--theme-text-muted);" data-rt="modelMappingHint">Map unsupported models to Antigravity models.</p>
                    </div>
                    <div id="mapping-save-status" class="text-xs" style="color: var(--theme-text-muted);"></div>
                </div>

                <!-- Add New Mapping -->
                <div class="grid gap-3 mb-4 flex-shrink-0 items-center" style="grid-template-columns: 1fr auto 1fr auto;">
                    <input id="mapping-source-input" list="preset-source-models" placeholder="Source model (e.g. deepseek-v3)"
                        class="select-field w-full" autocomplete="off" />
                    <span class="text-lg" style="color: var(--theme-accent);">‚Üí</span>
                    <select id="mapping-target-select" class="select-field w-full">
                        <option value="" data-rt="selectTarget">Select target model</option>
                    </select>
                    <button onclick="addModelMapping()"
                        class="action-btn px-4 py-2 rounded-lg font-bold text-xs" style="color: var(--theme-text);" data-rt="add">
                        Add
                    </button>
                </div>
                <datalist id="preset-source-models"></datalist>

                <!-- Mapping List -->
                <div id="mapping-list" class="space-y-2 flex-1 min-h-0 overflow-y-auto panel-scroll"></div>
            </section>
        </div>
    </div>

    <script>
        const API_BASE = `${window.location.protocol}//${window.location.hostname}:8964`;

        // ÂÖºÂÆπ HTTP ÁéØÂ¢ÉÁöÑ UUID ÁîüÊàêÂáΩÊï∞Ôºàcrypto.randomUUID Âè™Âú® HTTPS ‰∏ãÂèØÁî®Ôºâ
        function generateUUID() {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return generateUUID();
            }
            // Fallback for HTTP context
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        const STORAGE_KEYS = {
            activeFlow: 'anti-api-active-flow',
            privacyMode: 'anti-api-privacy-mode',
        };
        const PROVIDER_ORDER = ['antigravity', 'codex', 'copilot'];
        const MODEL_GROUPS = {
            // Claude ÈÖçÈ¢ùÁªÑÔºöÊâÄÊúâ Claude Ê®°Âûã + GPT-OSS
            claudeGpt: [
                'claude-opus-4-5-thinking',
                'claude-sonnet-4-5', 'claude-sonnet-4-5-thinking',
                'claude-haiku-4-5', 'claude-haiku-4-5-thinking',
                'claude-opus-4', 'claude-opus-4-thinking',
                'claude-sonnet-4', 'claude-sonnet-4-thinking',
                'gpt-oss-120b'
            ],
            // Gemini Pro ÈÖçÈ¢ùÁªÑÔºöÊâÄÊúâ Gemini 3 Pro Âèò‰Ωì
            gpro: [
                'gemini-3-pro', 'gemini-3-pro-low', 'gemini-3-pro-high',
                'gemini-3-pro-latest', 'gemini-3-pro-high-latest'
            ],
            // Gemini Flash ÈÖçÈ¢ùÁªÑÔºöÊâÄÊúâ Gemini 3 Flash Âèò‰Ωì
            gflash: [
                'gemini-3-flash', 'gemini-3-flash-latest',
                'gemini-3-flash-lite', 'gemini-3-flash-lite-latest'
            ],
            // Gemini Image ÈÖçÈ¢ùÁªÑÔºöÊâÄÊúâÁîªÂõæÊ®°ÂûãÂèò‰Ωì
            gimage: [
                'gemini-3-pro-image',
                'gemini-3-pro-image-1x1', 'gemini-3-pro-image-1-1',
                'gemini-3-pro-image-16x9', 'gemini-3-pro-image-16-9',
                'gemini-3-pro-image-9x16', 'gemini-3-pro-image-9-16',
                'gemini-3-pro-image-4x3', 'gemini-3-pro-image-4-3',
                'gemini-3-pro-image-3x4', 'gemini-3-pro-image-3-4',
                'gemini-3-pro-image-21x9', 'gemini-3-pro-image-21-9',
                'gemini-3-pro-image-2k', 'gemini-3-pro-image-4k',
                'gemini-3-pro-image-2k-1x1', 'gemini-3-pro-image-4k-1x1',
                'gemini-3-pro-image-2k-16x9', 'gemini-3-pro-image-4k-16x9',
                'gemini-3-pro-image-2k-9x16', 'gemini-3-pro-image-4k-9x16',
                'gemini-3-pro-image-2k-4x3', 'gemini-3-pro-image-4k-4x3',
                'gemini-3-pro-image-2k-3x4', 'gemini-3-pro-image-4k-3x4',
                'gemini-3-pro-image-2k-21x9', 'gemini-3-pro-image-4k-21x9'
            ]
        };

        const dom = {
            byId: (id) => document.getElementById(id),
            qs: (sel, root = document) => root.querySelector(sel),
            qsa: (sel, root = document) => Array.from(root.querySelectorAll(sel)),
        };

        function readBoolStorage(key, fallback = false) {
            try {
                const value = localStorage.getItem(key);
                if (value === null) return fallback;
                return value === 'true';
            } catch {
                return fallback;
            }
        }

        function safeJsonParse(text) {
            if (!text) return null;
            try {
                return JSON.parse(text);
            } catch {
                return null;
            }
        }

        async function apiJson(path, options = {}) {
            const response = await fetch(`${API_BASE}${path}`, options);
            const text = await response.text();
            const data = safeJsonParse(text);
            if (!response.ok) {
                const errorMessage = (data && (data.error || data.message)) ? (data.error || data.message) : (text || response.statusText);
                throw new Error(errorMessage);
            }
            return data || {};
        }

        async function apiPost(path, body) {
            return apiJson(path, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
        }

        let accounts = {};
        let models = {};
        let flows = [];
        let flowEntries = [];
        let activeFlowId = null;
        let quotaData = null;  // Store quota data for model rendering
        let accountRouting = { smartSwitch: false, routes: [] };
        let disabledAccounts = [];  // üÜï Á¶ÅÁî®ÁöÑË¥¶Êà∑ÂàóË°®
        let officialModels = [];
        let selectedAccountModelId = null;
        let activeRoutingTab = 'flow';
        let modelMappings = [];  // üÜï Ê®°ÂûãÊò†Â∞ÑÈÖçÁΩÆ
        let presetSourceModels = [];  // üÜï È¢ÑÁΩÆÁöÑÊ∫êÊ®°ÂûãÂàóË°®

        // üÜï Ê£ÄÊü•Ë¥¶Êà∑ÊòØÂê¶Ë¢´Á¶ÅÁî®
        function isAccountDisabled(provider, accountId) {
            const key = `${provider}:${accountId}`;
            return disabledAccounts.includes(key);
        }

        // üÜï ÂàáÊç¢Ë¥¶Êà∑Á¶ÅÁî®Áä∂ÊÄÅ
        async function toggleAccountDisabled(provider, accountId, event) {
            if (event) event.stopPropagation();
            try {
                const res = await apiPost('/routing/toggle-account', { provider, accountId });
                if (res.success) {
                    const key = `${provider}:${accountId}`;
                    if (res.disabled) {
                        if (!disabledAccounts.includes(key)) {
                            disabledAccounts.push(key);
                        }
                    } else {
                        const idx = disabledAccounts.indexOf(key);
                        if (idx >= 0) disabledAccounts.splice(idx, 1);
                    }
                    renderAccounts();
                }
            } catch (error) {
                console.error('Failed to toggle account:', error);
            }
        }

        // Privacy masking (synced from settings via localStorage cache)
        function getPrivacyMode() {
            return readBoolStorage(STORAGE_KEYS.privacyMode, false);
        }

        function maskEmail(email) {
            if (!getPrivacyMode() || !email) return email;
            const atIndex = email.indexOf('@');
            if (atIndex < 0) return maskUsername(email);

            const local = email.substring(0, atIndex);
            const domain = email.substring(atIndex + 1);
            const dotIndex = domain.lastIndexOf('.');

            // Mask local part: first 2 + ** + last 2
            let maskedLocal;
            if (local.length <= 4) {
                maskedLocal = local[0] + '**' + (local.length > 1 ? local[local.length - 1] : '');
            } else {
                maskedLocal = local.substring(0, 2) + '**' + local.substring(local.length - 2);
            }

            // Mask domain: first letter + ** + extension (e.g., g**.com)
            const ext = dotIndex >= 0 ? domain.substring(dotIndex) : '';
            const domainName = dotIndex >= 0 ? domain.substring(0, dotIndex) : domain;
            const maskedDomain = (domainName.length > 0 ? domainName[0] : '') + '**' + ext;

            return maskedLocal + '@' + maskedDomain;
        }

        function maskUsername(name) {
            if (!getPrivacyMode() || !name) return name;
            if (name.length <= 3) return name[0] + '*'.repeat(name.length - 1);
            return name.substring(0, 3) + '*'.repeat(Math.min(4, name.length - 3));
        }

        function setRoutingTab(tab) {
            activeRoutingTab = tab;
            const flowPanel = dom.byId('flow-panel');
            const accountPanel = dom.byId('account-panel');
            const mappingPanel = dom.byId('mapping-panel');
            const flowBtn = dom.byId('tab-flow');
            const accountBtn = dom.byId('tab-account');
            const mappingBtn = dom.byId('tab-mapping');

            if (flowPanel) flowPanel.classList.toggle('hidden', tab !== 'flow');
            if (accountPanel) accountPanel.classList.toggle('hidden', tab !== 'account');
            if (mappingPanel) mappingPanel.classList.toggle('hidden', tab !== 'mapping');

            [flowBtn, accountBtn, mappingBtn].forEach(btn => {
                if (!btn) return;
                const isActive = (btn === flowBtn && tab === 'flow') ||
                                 (btn === accountBtn && tab === 'account') ||
                                 (btn === mappingBtn && tab === 'mapping');
                btn.classList.toggle('text-cyan-300', isActive);
                btn.classList.toggle('border-cyan-300/70', isActive);
                btn.classList.toggle('text-gray-300', !isActive);
            });

            if (tab === 'flow') {
                requestAnimationFrame(drawFlowLines);
            }
            if (tab === 'mapping') {
                renderModelMappings();
            }
        }

        function collectOfficialModels(modelData) {
            const map = new Map();
            Object.values(modelData || {}).forEach(list => {
                (list || []).forEach(model => {
                    if (!map.has(model.id)) {
                        map.set(model.id, model.label || model.id);
                    }
                });
            });
            return Array.from(map.entries())
                .map(([id, label]) => ({ id, label }))
                .sort((a, b) => a.id.localeCompare(b.id));
        }

        function getProvidersForModel(modelId) {
            return Object.entries(models)
                .filter(([, list]) => (list || []).some(model => model.id === modelId))
                .map(([provider]) => provider);
        }

        function getAccountRoute(modelId) {
            return accountRouting.routes.find(route => route.modelId === modelId) || null;
        }

        function ensureAccountRoute(modelId) {
            let route = getAccountRoute(modelId);
            if (!route) {
                route = { id: generateUUID(), modelId, entries: [] };
                accountRouting.routes.push(route);
            }
            return route;
        }

        function renderAccountRouting() {
            const smartSwitchInput = dom.byId('smart-switch');
            if (smartSwitchInput) {
                smartSwitchInput.checked = !!accountRouting.smartSwitch;
                smartSwitchInput.onchange = () => {
                    accountRouting.smartSwitch = smartSwitchInput.checked;
                    renderAccountRouteEditor();
                    void persistAccountRoutingOnly();
                };
            }

            renderAccountModels();
            if (!selectedAccountModelId && officialModels.length > 0) {
                selectedAccountModelId = officialModels[0].id;
            }
            renderAccountRouteEditor();
        }

        function renderAccountRoutingView() {
            renderAccountModels();
            renderAccountRouteEditor();
        }

        function renderAccountModels() {
            const container = dom.byId('account-model-list');
            if (!container) return;
            container.innerHTML = '';

            if (officialModels.length === 0) {
                container.innerHTML = '<div class="text-xs text-gray-500">No official models available.</div>';
                return;
            }

            officialModels.forEach(model => {
                const route = getAccountRoute(model.id);
                const count = route?.entries?.length || 0;
                const card = document.createElement('button');
                const isActive = model.id === selectedAccountModelId;
                card.className = `node node-palette w-full text-left rounded-xl px-3 py-3 text-xs space-y-1 ${isActive ? 'border-cyan-300/70 shadow-[0_0_18px_rgba(110,231,255,0.25)]' : ''}`;
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-semibold text-gray-200">${model.label}</span>
                        <span class="account-pill text-[10px] px-2 py-0.5 rounded-full">${count} hops</span>
                    </div>
                    <div class="text-[10px] text-gray-500">${model.id}</div>
                `;
                card.addEventListener('click', () => {
                    selectedAccountModelId = model.id;
                    renderAccountModels();
                    renderAccountRouteEditor();
                });
                container.appendChild(card);
            });
        }

        function renderAccountRouteEditor() {
            const title = dom.byId('account-route-title');
            const list = dom.byId('account-route-list');
            const providerSelect = dom.byId('account-provider-select');
            const accountSelect = dom.byId('account-account-select');
            const hint = dom.byId('account-route-hint');

            if (!title || !list || !providerSelect || !accountSelect) return;

            if (!selectedAccountModelId) {
                title.textContent = 'Select a model';
                list.innerHTML = '';
                return;
            }

            title.textContent = `Model: ${selectedAccountModelId}`;
            list.innerHTML = '';

            const route = ensureAccountRoute(selectedAccountModelId);

            route.entries.forEach((entry, index) => {
                const card = document.createElement('div');
                card.className = 'node rounded-xl px-3 py-3 text-xs flex items-center justify-between gap-3';
                const rawLabel = entry.accountLabel || entry.accountId;
                const display = entry.accountId === 'auto'
                    ? 'Auto (Smart Switch)'
                    : (entry.provider === 'copilot' ? maskUsername(rawLabel) : maskEmail(rawLabel));
                card.innerHTML = `
                    <div>
                        <div class="text-[10px] uppercase tracking-[0.2em] text-gray-500">${entry.provider}</div>
                        <div class="text-sm font-semibold text-gray-200 mt-1">${display}</div>
                    </div>
                    <div class="flex items-center gap-2 text-[10px] text-gray-500">
                        <button onclick="moveAccountRouteEntry(${index}, -1)">Up</button>
                        <button onclick="moveAccountRouteEntry(${index}, 1)">Down</button>
                        <button onclick="removeAccountRouteEntry(${index})">Remove</button>
                    </div>
                `;
                list.appendChild(card);
            });

            if (route.entries.length === 0) {
                list.innerHTML = '<div class="text-xs text-gray-500">No entries yet.</div>';
            }

            const providers = getProvidersForModel(selectedAccountModelId);
            providerSelect.innerHTML = '<option value="">Provider</option>';
            providers.forEach(provider => {
                const option = document.createElement('option');
                option.value = provider;
                option.textContent = provider;
                providerSelect.appendChild(option);
            });

            providerSelect.onchange = () => updateAccountSelectOptions();
            updateAccountSelectOptions();

            if (hint) {
                hint.textContent = accountRouting.smartSwitch
                    ? 'Smart Switch on: auto entries expand by account order.'
                    : 'Smart Switch off: only explicit account order is used.';
            }
        }

        function updateAccountSelectOptions() {
            const providerSelect = dom.byId('account-provider-select');
            const accountSelect = dom.byId('account-account-select');
            const smartSwitchInput = dom.byId('smart-switch');
            if (!providerSelect || !accountSelect) return;

            const provider = providerSelect.value;
            accountSelect.innerHTML = '<option value="">Account</option>';

            if (!provider) return;

            if (smartSwitchInput?.checked) {
                const autoOption = document.createElement('option');
                autoOption.value = 'auto';
                autoOption.textContent = 'Auto (Smart Switch)';
                accountSelect.appendChild(autoOption);
            }

            const accountList = accounts[provider] || [];
            accountList.forEach(account => {
                const option = document.createElement('option');
                option.value = account.id;
                option.textContent = account.displayName || account.id;
                accountSelect.appendChild(option);
            });
        }

        function addAccountRouteEntry() {
            if (!selectedAccountModelId) return;
            const providerSelect = dom.byId('account-provider-select');
            const accountSelect = dom.byId('account-account-select');
            if (!providerSelect || !accountSelect) return;

            const provider = providerSelect.value;
            const accountId = accountSelect.value;
            if (!provider || !accountId) return;

            const route = ensureAccountRoute(selectedAccountModelId);
            const displayName = accountId === 'auto'
                ? 'Auto (Smart Switch)'
                : (accounts[provider] || []).find(acc => acc.id === accountId)?.displayName;
            route.entries.push({
                id: generateUUID(),
                provider,
                accountId,
                accountLabel: displayName,
            });
            renderAccountRoutingView();
        }

        function moveAccountRouteEntry(index, delta) {
            if (!selectedAccountModelId) return;
            const route = ensureAccountRoute(selectedAccountModelId);
            const target = index + delta;
            if (target < 0 || target >= route.entries.length) return;
            const [item] = route.entries.splice(index, 1);
            route.entries.splice(target, 0, item);
            renderAccountRoutingView();
        }

        function removeAccountRouteEntry(index) {
            if (!selectedAccountModelId) return;
            const route = ensureAccountRoute(selectedAccountModelId);
            route.entries.splice(index, 1);
            renderAccountRoutingView();
        }

        async function saveAccountRouting() {
            await persistAccountRoutingOnly();
        }

        async function loadRouting() {
            let data;
            try {
                data = await apiJson('/routing/config');
            } catch (error) {
                console.error('Failed to load routing config:', error);
                return;
            }
            accounts = data.accounts || {};
            models = data.models || {};
            flows = Array.isArray(data.config?.flows) ? data.config.flows : [];
            quotaData = data.quota || null;
            accountRouting = data.config?.accountRouting || { smartSwitch: false, routes: [] };
            disabledAccounts = data.config?.disabledAccounts || [];  // üÜï Âä†ËΩΩÁ¶ÅÁî®Ë¥¶Êà∑ÂàóË°®
            officialModels = collectOfficialModels(models);

            const savedFlowId = localStorage.getItem(STORAGE_KEYS.activeFlow);
            const initialFlow = flows.find(flow => flow.id === savedFlowId) || flows[0] || null;
            setActiveFlow(initialFlow);
            renderAccounts();
            bindCanvasEvents();
            renderAccountRouting();
            loadModelMappings();  // üÜï Âä†ËΩΩÊ®°ÂûãÊò†Â∞Ñ
            setRoutingTab(activeRoutingTab);
        }

        function cloneEntries(entries) {
            return (entries || []).map(entry => ({ ...entry }));
        }

        async function setActiveFlow(flow) {
            activeFlowId = flow ? flow.id : null;
            flowEntries = flow ? cloneEntries(flow.entries) : [];

            const nameInput = dom.byId('flow-name');
            if (nameInput) {
                nameInput.value = flow?.name || '';
            }

            if (activeFlowId) {
                localStorage.setItem(STORAGE_KEYS.activeFlow, activeFlowId);
            } else {
                localStorage.removeItem(STORAGE_KEYS.activeFlow);
            }

            // üÜï ÂêåÊ≠•Âà∞ÂêéÁ´ØÔºåËÆ©ÊúçÂä°Âô®Áü•ÈÅìÂΩìÂâçÊøÄÊ¥ªÁöÑ flow
            try {
                await apiPost('/routing/active-flow', { flowId: activeFlowId });
                console.log(`Active flow set: ${flow?.name || '(none)'}`);
            } catch (e) {
                console.error('Failed to set active flow:', e);
            }

            renderFlow();
            renderSavedFlows();
        }

        function renderSavedFlows() {
            const container = dom.byId('saved-list');
            if (!container) return;
            container.innerHTML = '';

            if (flows.length === 0) {
                container.innerHTML = `<div class="text-xs text-gray-500">No saved flows yet.</div>`;
                return;
            }

            flows.forEach(flow => {
                const card = document.createElement('div');
                const isActive = flow.id === activeFlowId;
                card.className = `node node-palette rounded-xl px-3 py-3 text-xs space-y-2 ${isActive ? 'border-cyan-300/70 shadow-[0_0_18px_rgba(110,231,255,0.25)]' : ''}`;

                const header = document.createElement('div');
                header.className = 'flex items-center justify-between';
                header.innerHTML = `
                    <div class="text-sm font-semibold text-gray-200">${flow.name}</div>
                    <span class="account-pill text-[10px] px-2 py-0.5 rounded-full">${flow.entries?.length || 0} hops</span>
                `;
                card.appendChild(header);

                const hint = document.createElement('div');
                hint.className = 'text-[10px] text-gray-500';
                hint.textContent = isActive ? 'Editing' : 'Click to edit';
                card.appendChild(hint);

                const actions = document.createElement('div');
                actions.className = 'flex items-center gap-3 text-[10px] text-gray-400';

                const loadBtn = document.createElement('button');
                loadBtn.textContent = isActive ? 'Editing' : 'Edit';
                loadBtn.disabled = isActive;
                loadBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    setActiveFlow(flow);
                });
                actions.appendChild(loadBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    deleteFlow(flow.id);
                });
                actions.appendChild(deleteBtn);

                card.appendChild(actions);
                card.addEventListener('click', () => setActiveFlow(flow));
                container.appendChild(card);
            });
        }

        function newFlow() {
            activeFlowId = null;
            flowEntries = [];
            const nameInput = dom.byId('flow-name');
            if (nameInput) {
                nameInput.value = '';
            }
            localStorage.removeItem(STORAGE_KEYS.activeFlow);
            renderFlow();
            renderSavedFlows();
        }

        async function deleteFlow(flowId) {
            flows = flows.filter(flow => flow.id !== flowId);
            if (activeFlowId === flowId) {
                newFlow();
            }
            await persistRoutingConfig();
        }

        // Get quota percentage for a provider/account
        function getAccountQuota(provider, accountId) {
            if (!quotaData || !quotaData.accounts) return null;

            // Find account in quotaData.accounts
            const accountData = quotaData.accounts.find(acc =>
                acc.provider === provider && acc.accountId === accountId
            );

            if (!accountData || !accountData.bars || accountData.bars.length === 0) return null;

            // Get the first bar's percentage (typically "claude_gpt" or similar)
            return accountData.bars[0].percentage;
        }

        // Get quota percentage for a specific model
        function getModelQuota(provider, accountId, modelId) {
            if (!quotaData || !quotaData.accounts) return null;
            if (provider !== 'antigravity') return null; // Only antigravity has model-level quotas

            const accountData = quotaData.accounts.find(acc =>
                acc.provider === provider && acc.accountId === accountId
            );

            if (!accountData || !accountData.bars) return null;

            let barKey = null;
            if (MODEL_GROUPS.claudeGpt.includes(modelId)) barKey = 'claude_gpt';
            else if (MODEL_GROUPS.gpro.includes(modelId)) barKey = 'gpro';
            else if (MODEL_GROUPS.gflash.includes(modelId)) barKey = 'gflash';
            else if (MODEL_GROUPS.gimage.includes(modelId)) barKey = 'gimage';

            if (!barKey) return null;

            const bar = accountData.bars.find(b => b.key === barKey);
            return bar ? bar.percentage : null;
        }

        function renderAccounts() {
            const container = dom.byId('account-list');
            container.innerHTML = '';
            let totalAccounts = 0;

            PROVIDER_ORDER.forEach(provider => {
                const providerAccounts = accounts[provider] || [];
                const providerModels = models[provider] || [];
                if (providerAccounts.length === 0) return;
                totalAccounts += providerAccounts.length;

                providerAccounts.forEach(account => {
                    const card = document.createElement('div');
                    card.className = 'space-y-2';

                    // üÜï Ê£ÄÊü•Ë¥¶Êà∑ÊòØÂê¶Ë¢´Á¶ÅÁî®
                    const accountDisabled = isAccountDisabled(provider, account.id);

                    // Get quota percentage for this account (quotaPercent = REMAINING percentage, not used)
                    const remaining = getAccountQuota(provider, account.id);

                    // Check if this account is collapsed (default to collapsed)
                    const collapseKey = `routing-collapse-${provider}-${account.id}`;
                    const storedValue = localStorage.getItem(collapseKey);
                    const isCollapsed = storedValue === null ? true : storedValue === 'true';

                    const maskedDisplayName = provider === 'copilot' ? maskUsername(account.displayName) : maskEmail(account.displayName);

                    const header = document.createElement('div');
                    header.className = 'flex items-center justify-between cursor-pointer hover:opacity-80 transition-opacity';
                    // üÜï Á¶ÅÁî®ÁöÑË¥¶Êà∑ÊòæÁ§∫ÁâπÊÆäÊ†∑Âºè
                    const disabledBadge = accountDisabled ? '<span class="text-[9px] px-1.5 py-0.5 rounded bg-red-500/20 text-red-400 ml-2">DISABLED</span>' : '';
                    const nameStyle = accountDisabled ? 'opacity-50 line-through' : '';
                    header.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-gray-500 transition-transform ${isCollapsed ? '' : 'rotate-90'}" data-toggle-icon>‚ñ∂</span>
                            <span class="text-sm font-semibold text-gray-200 ${nameStyle}">${maskedDisplayName}</span>
                            ${disabledBadge}
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleAccountDisabled('${provider}', '${account.id}', event)"
                                class="text-[9px] px-2 py-0.5 rounded ${accountDisabled ? 'bg-green-500/20 text-green-400 hover:bg-green-500/30' : 'bg-red-500/20 text-red-400 hover:bg-red-500/30'}"
                                title="${accountDisabled ? 'Enable this account' : 'Disable this account'}">
                                ${accountDisabled ? 'Enable' : 'Disable'}
                            </button>
                            <span class="account-pill text-[10px] px-2 py-0.5 rounded-full">${provider}</span>
                        </div>
                    `;
                    card.appendChild(header);

                    const modelGrid = document.createElement('div');
                    modelGrid.className = 'grid gap-1.5 overflow-hidden transition-all duration-200';
                    modelGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(90px, 1fr))';
                    modelGrid.style.maxHeight = isCollapsed ? '0px' : '2000px';
                    modelGrid.style.opacity = isCollapsed ? '0' : '1';
                    modelGrid.style.paddingTop = isCollapsed ? '0' : '8px';

                    // Toggle collapse on header click
                    header.addEventListener('click', () => {
                        const nowCollapsed = modelGrid.style.maxHeight !== '0px';
                        modelGrid.style.maxHeight = nowCollapsed ? '0px' : '2000px';
                        modelGrid.style.opacity = nowCollapsed ? '0' : '1';
                        modelGrid.style.paddingTop = nowCollapsed ? '0' : '8px';
                        header.querySelector('[data-toggle-icon]').classList.toggle('rotate-90', !nowCollapsed);
                        localStorage.setItem(collapseKey, nowCollapsed ? 'true' : 'false');
                    });

                    providerModels.forEach(model => {
                        const node = document.createElement('div');
                        node.className = 'node flow-node rounded-lg px-1.5 py-1.5 text-[10px] cursor-grab relative overflow-hidden text-center';
                        node.draggable = true;
                        node.dataset.provider = provider;
                        node.dataset.accountId = account.id;
                        node.dataset.modelId = model.id;
                        node.dataset.label = model.label;
                        node.dataset.accountLabel = account.displayName;

                        // Get model-specific quota (for antigravity) or account quota (for others)
                        const modelQuota = getModelQuota(provider, account.id, model.id) ?? getAccountQuota(provider, account.id);
                        const baseGradient = "linear-gradient(145deg, rgba(110, 231, 255, 0.14), rgba(10, 10, 10, 0.9))";

                        // Combine flow gradient with battery fill effect
                        if (modelQuota !== null) {
                            node.style.backgroundImage = `linear-gradient(90deg,
                                rgba(110, 231, 255, 0.22) 0%,
                                rgba(110, 231, 255, 0.16) ${modelQuota}%,
                                rgba(10, 10, 10, 0.95) ${modelQuota}%), ${baseGradient}`;
                        } else {
                            node.style.backgroundImage = baseGradient;
                        }

                        // Shorten model label for compact display
                        const shortLabel = model.label
                            .replace('Gemini 3 Pro Image ', 'Img ')
                            .replace('Gemini 3 Pro ', 'G3P ')
                            .replace('Gemini 3 Flash', 'G3Flash')
                            .replace('Gemini 2.5 Flash ', 'G2.5F ')
                            .replace('Gemini 2.5 Pro', 'G2.5Pro')
                            .replace('Gemini 2.0 Flash ', 'G2F ')
                            .replace('Claude Opus 4.5 ', 'Op4.5 ')
                            .replace('Claude Sonnet 4.5 ', 'So4.5 ')
                            .replace('Claude Haiku 4.5 ', 'Ha4.5 ')
                            .replace('Claude Opus 4 ', 'Op4 ')
                            .replace('Claude Sonnet 4 ', 'So4 ')
                            .replace('GPT-OSS 120B (Medium)', 'OSS-120B')
                            .replace('(Thinking)', 'T')
                            .replace('(Experimental)', 'Exp')
                            .replace('(High)', 'H')
                            .replace('(Low)', 'L')
                            .replace(' Lite', 'L');

                        node.innerHTML = `
                            <div class="relative z-10 leading-tight">
                                <div class="truncate">${shortLabel}</div>
                                ${modelQuota !== null ? `<div class="text-cyan-400/70 text-[9px]">${modelQuota}%</div>` : ''}
                            </div>
                        `;
                        node.title = model.label; // Full name on hover
                        node.addEventListener('dragstart', onDragStart);
                        modelGrid.appendChild(node);
                    });

                    card.appendChild(modelGrid);
                    container.appendChild(card);
                });
            });

            if (totalAccounts === 0) {
                container.innerHTML = `<div class="text-xs text-gray-500">No accounts yet. Add accounts from /quota.</div>`;
            }
        }

        function renderFlow() {
            const canvas = dom.byId('flow-canvas');
            if (!canvas) return;
            canvas.innerHTML = '';

            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('id', 'flow-lines');
            svg.setAttribute('class', 'flow-lines');
            canvas.appendChild(svg);

            flowEntries.forEach((entry, i) => {
                const node = document.createElement('div');
                node.className = 'node flow-node rounded-2xl px-4 py-3 text-sm cursor-grab';
                node.draggable = true;
                node.dataset.sourceIndex = i;
                node.dataset.flowIndex = i;
                node.addEventListener('dragstart', onDragStart);
                node.addEventListener('dragover', onNodeDragOver);
                node.addEventListener('dragleave', onNodeDragLeave);
                node.addEventListener('drop', onNodeDrop);
                // Apply privacy masking to account label
                const rawAccountLabel = entry.accountLabel || entry.accountId;
                const maskedAccountLabel = entry.provider === 'copilot' ? maskUsername(rawAccountLabel) : maskEmail(rawAccountLabel);

                node.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flow-badge">${i + 1}</div>
                        <span class="text-[10px] uppercase tracking-[0.2em] text-gray-500">${entry.provider}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-2">${maskedAccountLabel}</div>
                    <div class="text-sm font-semibold text-gray-200 mt-1">${entry.label}</div>
                    <div class="text-[10px] text-gray-500 mt-2">fallback on 429</div>
                    <button class="text-[10px] text-gray-500 mt-2" onclick="removeEntry(${i})">Remove</button>
                    <span class="flow-port flow-port-top"></span>
                    <span class="flow-port flow-port-bottom"></span>
                `;
                canvas.appendChild(node);
            });

            const slot = document.createElement('div');
            slot.className = 'drop-slot';
            slot.dataset.index = flowEntries.length;
            slot.textContent = 'Drop here';
            slot.addEventListener('dragover', onDragOver);
            slot.addEventListener('dragleave', onDragLeave);
            slot.addEventListener('drop', onDrop);
            canvas.appendChild(slot);

            requestAnimationFrame(drawFlowLines);
        }

        function createEntryFromPayload(payload) {
            return {
                id: generateUUID(),
                provider: payload.provider,
                accountId: payload.accountId,
                modelId: payload.modelId,
                label: payload.label,
                accountLabel: payload.accountLabel
            };
        }

        function onDragStart(event) {
            const node = event.target;
            const payload = {
                provider: node.dataset.provider,
                accountId: node.dataset.accountId,
                modelId: node.dataset.modelId,
                label: node.dataset.label,
                accountLabel: node.dataset.accountLabel,
                sourceIndex: node.dataset.sourceIndex
            };
            event.dataTransfer.setData('application/json', JSON.stringify(payload));
        }

        function onDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('active');
        }

        function onDragLeave(event) {
            event.currentTarget.classList.remove('active');
        }

        function onDrop(event) {
            event.preventDefault();
            const slot = event.currentTarget;
            slot.classList.remove('active');
            const index = Number(slot.dataset.index);
            const payload = JSON.parse(event.dataTransfer.getData('application/json'));

            if (payload.sourceIndex !== undefined) {
                const from = Number(payload.sourceIndex);
                const [moved] = flowEntries.splice(from, 1);
                flowEntries.splice(index > from ? index - 1 : index, 0, moved);
                renderFlow();
                return;
            }

            const entry = createEntryFromPayload(payload);
            flowEntries.splice(index, 0, entry);
            renderFlow();
        }

        function onNodeDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drop-target');
        }

        function onNodeDragLeave(event) {
            event.currentTarget.classList.remove('drop-target');
        }

        function onNodeDrop(event) {
            event.preventDefault();
            const node = event.currentTarget;
            node.classList.remove('drop-target');
            const targetIndex = Number(node.dataset.flowIndex);
            const payload = JSON.parse(event.dataTransfer.getData('application/json'));

            if (payload.sourceIndex !== undefined) {
                const from = Number(payload.sourceIndex);
                const [moved] = flowEntries.splice(from, 1);
                const insertIndex = from < targetIndex ? targetIndex - 1 : targetIndex;
                flowEntries.splice(insertIndex, 0, moved);
                renderFlow();
                return;
            }

            const entry = createEntryFromPayload(payload);
            flowEntries.splice(targetIndex, 0, entry);
            renderFlow();
        }

        function removeEntry(index) {
            flowEntries.splice(index, 1);
            renderFlow();
        }

        async function saveRouting() {
            const status = dom.byId('save-status');
            const nameInput = dom.byId('flow-name');
            const flowName = nameInput ? nameInput.value.trim() : '';

            if (!flowName) {
                status.textContent = 'Flow name required';
                setTimeout(() => status.textContent = '', 2000);
                return;
            }

            const existingByName = flows.find(flow => flow.name === flowName && flow.id !== activeFlowId);
            if (existingByName) {
                status.textContent = 'Flow name already exists';
                setTimeout(() => status.textContent = '', 2000);
                return;
            }

            const flowId = activeFlowId || generateUUID();
            const flow = { id: flowId, name: flowName, entries: flowEntries };
            const index = flows.findIndex(existing => existing.id === flowId);

            if (index >= 0) {
                flows[index] = flow;
            } else {
                flows.push(flow);
            }

            activeFlowId = flowId;
            status.textContent = 'Saving...';
            await persistRoutingConfig();
            status.textContent = 'Saved';
            setTimeout(() => status.textContent = '', 2000);
        }

        function clearRouting() {
            flowEntries = [];
            renderFlow();
        }

        function rotateRouting() {
            if (flowEntries.length > 1) {
                const first = flowEntries.shift();
                flowEntries.push(first);
                renderFlow();
            }
        }

        async function persistRoutingConfig() {
            let data;
            try {
                data = await apiPost('/routing/config', { flows, accountRouting });
            } catch (error) {
                console.error('Failed to save routing config:', error);
                return;
            }
            flows = Array.isArray(data.config?.flows) ? data.config.flows : flows;
            accountRouting = data.config?.accountRouting || accountRouting;
            const active = flows.find(flow => flow.id === activeFlowId) || null;
            setActiveFlow(active);
            renderAccountRouting();
        }

        async function persistAccountRoutingOnly() {
            let data;
            try {
                data = await apiPost('/routing/config', { accountRouting });
            } catch (error) {
                console.error('Failed to save account routing:', error);
                return;
            }
            accountRouting = data.config?.accountRouting || accountRouting;
            renderAccountRouting();
        }

        function bindCanvasEvents() {
            const canvas = dom.byId('flow-canvas');
            const scrollContainer = dom.qs('.flow-scroll');
            if (!canvas || canvas.dataset.bound) return;
            canvas.dataset.bound = 'true';

            // Bind scroll event to the scrollable container
            if (scrollContainer) {
                scrollContainer.addEventListener('scroll', () => {
                    requestAnimationFrame(drawFlowLines);
                }, { passive: true });
            }
        }

        function drawFlowLines() {
            const canvas = dom.byId('flow-canvas');
            const svg = canvas ? canvas.querySelector('#flow-lines') : null;
            if (!canvas || !svg) return;

            const width = Math.max(canvas.scrollWidth, canvas.clientWidth);
            const height = Math.max(canvas.scrollHeight, canvas.clientHeight);

            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            svg.style.width = `${width}px`;
            svg.style.height = `${height}px`;

            const canvasRect = canvas.getBoundingClientRect();
            const scrollLeft = canvas.scrollLeft;
            const scrollTop = canvas.scrollTop;

            const nodes = Array.from(canvas.querySelectorAll('.flow-node'))
                .sort((a, b) => Number(a.dataset.flowIndex) - Number(b.dataset.flowIndex));

            const defs = `
                <defs>
                    <linearGradient id="flow-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="#6ee7ff" stop-opacity="0.9"></stop>
                        <stop offset="60%" stop-color="#8b9bff" stop-opacity="0.9"></stop>
                        <stop offset="100%" stop-color="#a78bfa" stop-opacity="0.9"></stop>
                    </linearGradient>
                    <filter id="flow-glow" x="-50%" y="-50%" width="200%" height="200%">
                        <feGaussianBlur stdDeviation="6" result="coloredBlur"></feGaussianBlur>
                        <feMerge>
                            <feMergeNode in="coloredBlur"></feMergeNode>
                            <feMergeNode in="SourceGraphic"></feMergeNode>
                        </feMerge>
                    </filter>
                </defs>
            `;

            let paths = '';
            for (let i = 0; i < nodes.length - 1; i++) {
                const current = nodes[i];
                const next = nodes[i + 1];
                const startPort = current.querySelector('.flow-port-bottom');
                const endPort = next.querySelector('.flow-port-top');
                if (!startPort || !endPort) continue;

                const startRect = startPort.getBoundingClientRect();
                const endRect = endPort.getBoundingClientRect();
                const startX = startRect.left - canvasRect.left + scrollLeft + startRect.width / 2;
                const startY = startRect.top - canvasRect.top + scrollTop + startRect.height / 2;
                const endX = endRect.left - canvasRect.left + scrollLeft + endRect.width / 2;
                const endY = endRect.top - canvasRect.top + scrollTop + endRect.height / 2;
                const curve = Math.max(40, Math.min(180, Math.abs(endY - startY) * 0.5));

                const path = `M ${startX} ${startY} C ${startX} ${startY + curve}, ${endX} ${endY - curve}, ${endX} ${endY}`;
                paths += `<path class="flow-line-glow" d="${path}"></path>`;
                paths += `<path class="flow-line-core" d="${path}"></path>`;
            }

            svg.innerHTML = `${defs}${paths}`;
        }

        // ==================== üÜï Ê®°ÂûãÊò†Â∞ÑÂäüËÉΩ ====================
        async function loadModelMappings() {
            try {
                const data = await apiJson('/routing/model-mappings');
                modelMappings = data.mappings || [];
                presetSourceModels = data.presets || [];
                populatePresetDatalist();
                populateTargetSelect();
                renderModelMappings();
            } catch (error) {
                console.error('Failed to load model mappings:', error);
            }
        }

        function populatePresetDatalist() {
            const datalist = dom.byId('preset-source-models');
            if (!datalist) return;
            datalist.innerHTML = '';
            presetSourceModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                datalist.appendChild(option);
            });
        }

        function populateTargetSelect() {
            const select = dom.byId('mapping-target-select');
            if (!select) return;
            select.innerHTML = `<option value="">${rt('selectTarget')}</option>`;
            officialModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = `${model.label} (${model.id})`;
                select.appendChild(option);
            });
        }

        function renderModelMappings() {
            const list = dom.byId('mapping-list');
            if (!list) return;
            list.innerHTML = '';

            if (modelMappings.length === 0) {
                list.innerHTML = `<div class="text-xs" style="color: var(--theme-text-muted);">${rt('noMappings')}</div>`;
                return;
            }

            modelMappings.forEach(mapping => {
                const card = document.createElement('div');
                card.className = 'node rounded-xl px-4 py-3 text-xs flex items-center justify-between gap-3';
                card.style.opacity = mapping.enabled ? '1' : '0.5';
                
                const targetModel = officialModels.find(m => m.id === mapping.target);
                const targetLabel = targetModel ? targetModel.label : mapping.target;
                
                card.innerHTML = `
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <code class="px-2 py-1 rounded text-sm truncate" style="background: var(--theme-card-bg); color: var(--theme-accent);">${mapping.source}</code>
                        <span style="color: var(--theme-accent);">‚Üí</span>
                        <span class="text-sm truncate" style="color: var(--theme-text);">${targetLabel}</span>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <button onclick="toggleModelMapping('${mapping.id}')"
                            class="text-[10px] px-2 py-1 rounded ${mapping.enabled ? 'bg-green-500/20 text-green-400' : 'bg-gray-500/20 text-gray-400'}">
                            ${mapping.enabled ? rt('enabled') : rt('disabled')}
                        </button>
                        <button onclick="deleteModelMapping('${mapping.id}')"
                            class="text-[10px] px-2 py-1 rounded bg-red-500/20 text-red-400 hover:bg-red-500/30">
                            ${rt('delete')}
                        </button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        async function addModelMapping() {
            const sourceInput = dom.byId('mapping-source-input');
            const targetSelect = dom.byId('mapping-target-select');
            const status = dom.byId('mapping-save-status');
            
            const source = sourceInput?.value?.trim();
            const target = targetSelect?.value;
            
            if (!source || !target) {
                if (status) {
                    status.textContent = rt('fillBothFields');
                    setTimeout(() => status.textContent = '', 2000);
                }
                return;
            }
            
            try {
                const data = await apiPost('/routing/model-mappings/add', { source, target });
                modelMappings = data.mappings || modelMappings;
                sourceInput.value = '';
                targetSelect.value = '';
                renderModelMappings();
                if (status) {
                    status.textContent = rt('added');
                    setTimeout(() => status.textContent = '', 2000);
                }
            } catch (error) {
                console.error('Failed to add mapping:', error);
                if (status) {
                    status.textContent = error.message || 'Failed';
                    setTimeout(() => status.textContent = '', 2000);
                }
            }
        }

        async function toggleModelMapping(id) {
            try {
                const data = await apiPost(`/routing/model-mappings/${id}/toggle`);
                modelMappings = data.mappings || modelMappings;
                renderModelMappings();
            } catch (error) {
                console.error('Failed to toggle mapping:', error);
            }
        }

        async function deleteModelMapping(id) {
            try {
                const data = await apiJson(`/routing/model-mappings/${id}`, { method: 'DELETE' });
                modelMappings = data.mappings || modelMappings;
                renderModelMappings();
            } catch (error) {
                console.error('Failed to delete mapping:', error);
            }
        }

        const routingExports = {
            setRoutingTab,
            newFlow,
            saveRouting,
            saveAccountRouting,
            addAccountRouteEntry,
            moveAccountRouteEntry,
            removeAccountRouteEntry,
            removeEntry,
            addModelMapping,
            toggleModelMapping,
            deleteModelMapping,
        };
        Object.assign(window, routingExports);

        loadRouting();
        window.addEventListener('resize', drawFlowLines);

        // Listen for privacy mode changes from other pages
        window.addEventListener('storage', (e) => {
            if (e.key === STORAGE_KEYS.privacyMode) {
                console.log('[Routing] Privacy mode changed, re-rendering...');
                renderAccounts();
                renderFlow();
                renderAccountRouting();
            }
            // üÜï ÁõëÂê¨‰∏ªÈ¢òÂèòÂåñ
            if (e.key === 'anti-api-theme') {
                applyTheme(e.newValue || 'midnight');
            }
        });

        // üÜï ÁõëÂê¨‰∏ªÈ¢òÂèòÂåñÔºà‰ªé‰∏ªÈ°µÈù¢ÂêåÊ≠•Ôºâ
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme || 'midnight');
            document.body.style.background = 'var(--theme-bg)';
        }

        // ÂàùÂßãÂåñÊó∂‰ªé localStorage ËØªÂèñ‰∏ªÈ¢ò
        const savedTheme = localStorage.getItem('anti-api-theme') || 'midnight';
        applyTheme(savedTheme);

        // ÁõëÂê¨Êù•Ëá™Áà∂È°µÈù¢ÁöÑ‰∏ªÈ¢òÊ∂àÊÅØÔºàiframe Ê®°ÂºèÔºâ
        window.addEventListener('message', (e) => {
            if (e.data && e.data.type === 'theme-change') {
                applyTheme(e.data.theme);
            }
            // üÜï ÁõëÂê¨ËØ≠Ë®ÄÂèòÂåñ
            if (e.data && e.data.type === 'language-change') {
                applyLanguage(e.data.lang);
            }
        });

        // üÜï Â§öËØ≠Ë®ÄÊîØÊåÅ
        const routingI18n = {
            en: {
                title: 'Routing',
                subtitle: 'Build model chains with fallback on 429',
                flowRouting: 'Flow Routing',
                accountRouting: 'Account Routing',
                modelMapping: 'Model Mapping',
                modelMappingHint: 'Map unsupported models to Antigravity models.',
                accounts: 'ACCOUNTS',
                accountsHint: 'Drag a model block into the flow.',
                flow: 'FLOW',
                flowHint: 'Match by model name in requests.',
                saved: 'SAVED',
                savedHint: 'Edit, rename, or delete saved flows.',
                new: 'New',
                save: 'Save',
                models: 'MODELS',
                modelsHint: 'Official model IDs only.',
                accountChain: 'ACCOUNT CHAIN',
                accountChainHint: 'Ordered provider/account fallback.',
                smartSwitch: 'Smart Switch',
                selectModel: 'Select a model',
                selectTarget: 'Select target model',
                noEntries: 'No entries yet.',
                noFlows: 'No saved flows yet.',
                noAccounts: 'No accounts yet. Add accounts from /quota.',
                noModels: 'No official models available.',
                noMappings: 'No model mappings yet. Add one above.',
                hops: 'hops',
                editing: 'Editing',
                clickToEdit: 'Click to edit',
                edit: 'Edit',
                delete: 'Delete',
                remove: 'Remove',
                up: 'Up',
                down: 'Down',
                add: 'Add',
                added: 'Added',
                provider: 'Provider',
                account: 'Account',
                fallbackOn429: 'fallback on 429',
                dropHere: 'Drop here',
                disable: 'Disable',
                enable: 'Enable',
                enabled: 'Enabled',
                disabled: 'Disabled',
                smartSwitchOn: 'Smart Switch on: auto entries expand by account order.',
                smartSwitchOff: 'Smart Switch off: only explicit account order is used.',
                backToQuota: 'Back to Quota',
                fillBothFields: 'Please fill both source and target',
            },
            zh: {
                title: 'Ë∑ØÁî±',
                subtitle: 'ÊûÑÂª∫ 429 Ëá™Âä®ÂàáÊç¢ÁöÑÊ®°ÂûãÈìæ',
                flowRouting: 'Flow Ë∑ØÁî±',
                accountRouting: 'Ë¥¶Êà∑Ë∑ØÁî±',
                modelMapping: 'Ê®°ÂûãÊò†Â∞Ñ',
                modelMappingHint: 'Â∞Ü‰∏çÊîØÊåÅÁöÑÊ®°ÂûãÊò†Â∞ÑÂà∞ Antigravity ÊîØÊåÅÁöÑÊ®°Âûã',
                accounts: 'Ë¥¶Êà∑',
                accountsHint: 'ÊãñÊãΩÊ®°ÂûãÂùóÂà∞ÊµÅÁ®ã‰∏≠',
                flow: 'ÊµÅÁ®ã',
                flowHint: 'ÊåâËØ∑Ê±Ç‰∏≠ÁöÑÊ®°ÂûãÂêçÂåπÈÖç',
                saved: 'Â∑≤‰øùÂ≠ò',
                savedHint: 'ÁºñËæë„ÄÅÈáçÂëΩÂêçÊàñÂà†Èô§Â∑≤‰øùÂ≠òÁöÑÊµÅÁ®ã',
                new: 'Êñ∞Âª∫',
                save: '‰øùÂ≠ò',
                models: 'Ê®°Âûã',
                modelsHint: '‰ªÖÂÆòÊñπÊ®°Âûã ID',
                accountChain: 'Ë¥¶Êà∑Èìæ',
                accountChainHint: 'ÊåâÈ°∫Â∫èÁöÑ‰æõÂ∫îÂïÜ/Ë¥¶Êà∑ÂõûÈÄÄ',
                smartSwitch: 'Êô∫ËÉΩÂàáÊç¢',
                selectModel: 'ÈÄâÊã©‰∏Ä‰∏™Ê®°Âûã',
                selectTarget: 'ÈÄâÊã©ÁõÆÊ†áÊ®°Âûã',
                noEntries: 'ÊöÇÊó†Êù°ÁõÆ',
                noFlows: 'ÊöÇÊó†Â∑≤‰øùÂ≠òÁöÑÊµÅÁ®ã',
                noAccounts: 'ÊöÇÊó†Ë¥¶Êà∑ÔºåËØ∑‰ªé /quota Ê∑ªÂä†',
                noModels: 'ÊöÇÊó†ÂèØÁî®ÁöÑÂÆòÊñπÊ®°Âûã',
                noMappings: 'ÊöÇÊó†Ê®°ÂûãÊò†Â∞ÑÔºåÂú®‰∏äÊñπÊ∑ªÂä†',
                hops: 'Ë∑≥',
                editing: 'ÁºñËæë‰∏≠',
                clickToEdit: 'ÁÇπÂáªÁºñËæë',
                edit: 'ÁºñËæë',
                delete: 'Âà†Èô§',
                remove: 'ÁßªÈô§',
                up: '‰∏äÁßª',
                down: '‰∏ãÁßª',
                add: 'Ê∑ªÂä†',
                added: 'Â∑≤Ê∑ªÂä†',
                provider: '‰æõÂ∫îÂïÜ',
                account: 'Ë¥¶Êà∑',
                fallbackOn429: '429 Êó∂ÂõûÈÄÄ',
                dropHere: 'ÊãñÊîæÂà∞ËøôÈáå',
                disable: 'Á¶ÅÁî®',
                enable: 'ÂêØÁî®',
                enabled: 'Â∑≤ÂêØÁî®',
                disabled: 'Â∑≤Á¶ÅÁî®',
                smartSwitchOn: 'Êô∫ËÉΩÂàáÊç¢ÂºÄÂêØÔºöËá™Âä®Êù°ÁõÆÊåâË¥¶Êà∑È°∫Â∫èÂ±ïÂºÄ',
                smartSwitchOff: 'Êô∫ËÉΩÂàáÊç¢ÂÖ≥Èó≠Ôºö‰ªÖ‰ΩøÁî®ÊòæÂºèË¥¶Êà∑È°∫Â∫è',
                backToQuota: 'ËøîÂõûÈÖçÈ¢ù',
                fillBothFields: 'ËØ∑Â°´ÂÜôÊ∫êÊ®°ÂûãÂíåÁõÆÊ†áÊ®°Âûã',
            }
        };

        let routingLang = localStorage.getItem('anti-api-language') || 'en';

        function rt(key) {
            return routingI18n[routingLang]?.[key] || routingI18n.en[key] || key;
        }

        function applyLanguage(lang) {
            routingLang = lang || 'en';

            // Êõ¥Êñ∞ÈùôÊÄÅ HTML ÂÖÉÁ¥†
            const titleEl = document.getElementById('routing-title');
            const subtitleEl = document.getElementById('routing-subtitle');
            if (titleEl) titleEl.textContent = rt('title');
            if (subtitleEl) subtitleEl.textContent = rt('subtitle');

            // Êõ¥Êñ∞ÊâÄÊúâ data-rt Â±ûÊÄßÁöÑÂÖÉÁ¥†
            document.querySelectorAll('[data-rt]').forEach(el => {
                const key = el.getAttribute('data-rt');
                if (key) {
                    el.textContent = rt(key);
                }
            });

            // ÈáçÊñ∞Ê∏≤ÊüìÂä®ÊÄÅÂÜÖÂÆπ‰ª•Â∫îÁî®Êñ∞ËØ≠Ë®Ä
            renderAccounts();
            renderFlow();
            renderSavedFlows();
            renderAccountRouting();
        }

        // ÂàùÂßãÂåñËØ≠Ë®Ä
        const initLang = localStorage.getItem('anti-api-language') || 'en';
        routingLang = initLang;

        // ÁõëÂê¨ storage ÂèòÂåñÔºàË∑®È°µÈù¢ÂêåÊ≠•ËØ≠Ë®ÄÔºâ
        window.addEventListener('storage', (e) => {
            if (e.key === 'anti-api-language') {
                applyLanguage(e.newValue || 'en');
            }
        });
    </script>
</body>

</html>
